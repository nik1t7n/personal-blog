---
import BaseLayout from './BaseLayout.astro';
import type { CollectionEntry } from 'astro:content';

type Props = CollectionEntry<'blog'>['data'] & {
	headings?: { depth: number; slug: string; text: string }[];
};

const { title, description, pubDate, author, image, headings = [] } = Astro.props;
---

<BaseLayout title={title} description={description} image={image?.url} fullWidth={true}>
	<div class="flex gap-8 max-w-[88vw] mx-auto px-8 py-12">
		<!-- Sidebar with Table of Contents (Desktop) -->
		<aside class="hidden lg:block w-64 flex-shrink-0">
			<div class="sticky top-12 mt-17">
				<h2 class="text-sm font-bold uppercase tracking-wider text-neutral-700 dark:text-neutral-300 mb-4">
					Table of Contents
				</h2>
				<nav class="space-y-1" id="toc-nav-desktop">
					{headings.filter((h) => h.depth <= 3).map((heading) => (
						<a 
							href={`#${heading.slug}`}
							class={`block py-1 text-sm transition-colors toc-link ${
								heading.depth === 2 
									? 'text-neutral-700 dark:text-neutral-300 hover:text-purple-600 dark:hover:text-purple-400 font-medium' 
									: 'text-neutral-500 dark:text-neutral-400 hover:text-purple-600 dark:hover:text-purple-400 pl-4'
							}`}
							data-heading-id={heading.slug}
						>
							{heading.text}
						</a>
					))}
				</nav>
			</div>
		</aside>

		<!-- Main content -->
		<main class="flex-1 max-w-3xl">
			<a 
				href="/" 
				class="text-sm text-neutral-500 hover:text-purple-600 dark:text-neutral-400 dark:hover:text-purple-400 transition-colors inline-block mb-8"
			>
				← Back
			</a>

			<article>
				<header class="mb-10">
					<h1 class="text-3xl md:text-4xl font-bold mb-3 text-neutral-900 dark:text-neutral-100">
						{title}
					</h1>
					<div class="flex items-center gap-3 text-sm text-neutral-500 dark:text-neutral-400">
						<time datetime={pubDate.toISOString()}>
							{pubDate.toLocaleDateString('en-US', {
								year: 'numeric',
								month: 'long',
								day: 'numeric',
							})}
						</time>
						<span>·</span>
						<span>{author}</span>
					</div>

					<!-- Mobile Table of Contents -->
					<div class="lg:hidden mt-6 border border-neutral-200 dark:border-neutral-700 rounded-lg overflow-hidden">
						<button 
							id="mobile-toc-toggle"
							class="w-full px-4 py-3 flex items-center justify-between bg-neutral-50 dark:bg-neutral-800/50 hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors"
							aria-expanded="false"
						>
							<span class="text-sm font-bold uppercase tracking-wider text-neutral-700 dark:text-neutral-300">
								Table of Contents
							</span>
							<svg 
								id="mobile-toc-icon" 
								class="w-5 h-5 text-neutral-600 dark:text-neutral-400 transition-transform duration-200" 
								fill="none" 
								stroke="currentColor" 
								viewBox="0 0 24 24"
							>
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
							</svg>
						</button>
						<div 
							id="mobile-toc-wrapper"
							class="max-h-0 overflow-hidden transition-all duration-300 ease-in-out"
						>
							<nav class="space-y-1 px-4 py-3 bg-white dark:bg-neutral-900">
								{headings.filter((h) => h.depth <= 3).map((heading) => (
									<a 
										href={`#${heading.slug}`}
										class={`block py-1.5 text-sm transition-colors toc-link mobile-toc-link ${
											heading.depth === 2 
												? 'text-neutral-700 dark:text-neutral-300 hover:text-purple-600 dark:hover:text-purple-400 font-medium' 
												: 'text-neutral-500 dark:text-neutral-400 hover:text-purple-600 dark:hover:text-purple-400 pl-4'
										}`}
										data-heading-id={heading.slug}
									>
										{heading.text}
									</a>
								))}
							</nav>
						</div>
					</div>
				</header>

				<div class="prose prose-neutral dark:prose-invert max-w-none prose-headings:font-bold prose-a:text-purple-600 dark:prose-a:text-purple-400 prose-a:no-underline hover:prose-a:underline prose-img:rounded-lg">
					<slot />
				</div>
			</article>
		</main>
	</div>
</BaseLayout>

<script>
	// Mobile TOC Toggle
	const mobileToggle = document.getElementById('mobile-toc-toggle');
	const mobileWrapper = document.getElementById('mobile-toc-wrapper');
	const mobileIcon = document.getElementById('mobile-toc-icon');

	if (mobileToggle && mobileWrapper && mobileIcon) {
		mobileToggle.addEventListener('click', () => {
			const isExpanded = mobileToggle.getAttribute('aria-expanded') === 'true';
			
			if (isExpanded) {
				mobileWrapper.style.maxHeight = '0';
				mobileIcon.style.transform = 'rotate(0deg)';
				mobileToggle.setAttribute('aria-expanded', 'false');
			} else {
				mobileWrapper.style.maxHeight = mobileWrapper.scrollHeight + 'px';
				mobileIcon.style.transform = 'rotate(180deg)';
				mobileToggle.setAttribute('aria-expanded', 'true');
			}
		});

		// Close mobile TOC when clicking on a link
		document.querySelectorAll('.mobile-toc-link').forEach((link) => {
			link.addEventListener('click', () => {
				mobileWrapper.style.maxHeight = '0';
				mobileIcon.style.transform = 'rotate(0deg)';
				mobileToggle.setAttribute('aria-expanded', 'false');
			});
		});
	}

	// Highlight active section in TOC based on scroll position
	const observer = new IntersectionObserver((entries) => {
		entries.forEach((entry) => {
			const id = entry.target.getAttribute('id');
			const tocLinks = document.querySelectorAll(`a[data-heading-id="${id}"]`);
			
			tocLinks.forEach((tocLink) => {
				if (tocLink) {
					if (entry.isIntersecting) {
						// Remove active class from all links
						document.querySelectorAll('.toc-link').forEach((link) => {
							link.classList.remove('text-purple-600', 'dark:text-purple-400', 'font-bold');
						});
						// Add active class to current link (both mobile and desktop)
						tocLinks.forEach((link) => {
							link.classList.add('text-purple-600', 'dark:text-purple-400', 'font-bold');
						});
					}
				}
			});
		});
	}, {
		rootMargin: '-100px 0px -66%',
		threshold: 1.0
	});

	// Observe all headings
	document.querySelectorAll('h2, h3').forEach((heading) => {
		observer.observe(heading);
	});
</script>
